# 链路层服务概述
- 链路层简介：
	- **节点（Node）**：网络中的设备，如计算机、路由器等
	- **链路（Link）**：连接相邻的通信节点的通信信道，分为有线链路（光纤等）、无线链路（Wi-Fi等）、局域网（LAN）
	- **帧（Frame）**：链路层传输的数据单元，包含数据和控制信息
	- 网络层数据报在实际传输时，运行在不同的链路层协议上，每个协议提供不同的服务
- 链路层服务：
	- 成帧与链路访问：
		- 将网络层数据报封装成帧，添加头部和尾部信息
		- 共享介质的信道访问控制
		- 用MAC地址标识源/目的节点
	- 相邻节点可靠传输：确保数据在相邻节点之间无丢失无错误传输
	- 流量控制：调节相邻节点之间的数据传输速率，防止接收方缓冲区溢出
	- 差错检测与纠正：
		- 检测由于噪声导致的比特错误，通知发送方重传
		- 使用信息直接识别传输错误并进行纠正，无需重传
	- 半双工与全双工通信：
		- 半双工：节点间交替发送和接收数据
		- 全双工：节点间同时发送和接收数据
- 链路层的实现位置：
	- 在主机中，链路层实现于网络接口卡（NIC）和上，通过总线和其他硬件通信
	- 主机的网卡可以发送链路层帧到直接相连的节点，也可以接收来自这些节点的帧
# 差错检测与纠正技术
- 原理：
	- EDC（Error Detection and Correction bits）：冗余比特，附加在数据后用于检测和纠正错误
	- D（Data bits）：数据比特，实际传输的数据
	- 传输模型：![[Pasted image 20251113174705.png]]
	- 特点：
		- 并非100%可靠，但能显著降低错误率
		- EDC越长，检测和纠正能力越强
- **奇偶校验**（Parity Checking）：
	- 单比特奇偶校验：在数据后添加一个奇偶校验位，使得数据中1的个数为偶数（偶校验）或奇数（奇校验）
		- 示意图：![[Pasted image 20251113175003.png]]
	- 二维奇偶校验：将数据组织成矩阵形式，对每行和每列分别计算奇偶校验位
		- 示意图：![[Pasted image 20251113175013.png]]
- **校验和**（Checksum）：
	- 检测传输分组中的比特翻转错误（也用于[[S3 运输层#^2d6780|传输层]]和网络层）
	- 原理：发送方将数据视为16位的整数序列，计算反码求和（并进行回卷），存入校验和字段；接收方进行相同计算，若结果全为1则无错误
- **循环冗余校验**（Cyclic Redundancy Check, CRC）：
	- 原理：
		- 将数据 $D$ 视为一个二进制数 
		- 选择 $r+1$ 位的生成多项式 $G$
		- 选择 $r$ 位的CRC冗余比特 $R$ 使得 $<D,R>$ 能被 $G$ 整除
		- 接收方对收到的 $<D,R>$ 进行除法运算，若余数为0则无错误
	- 数学表示：$D\times 2^r \text{XOR} R \mod G = 0$![[Pasted image 20251113175525.png]]
	- 例：![[Pasted image 20251113175618.png]]
# 多路访问协议(MAC)
- 背景：
	- 链路分为点对点的链路和广播型的链路
	- 当多节点共享同一广播型链路时，需要一种机制来协调节点对链路的访问，避免冲突
	- 理想的协议在单节点传输时，速率达到信道最大速率；多节点传输时，平均分配信道资源
## 信道划分协议
- 原理：将信道资源划分为多个独立的子信道，每个节点分配一个子信道进行通信
- 类型：
	- 时分多路访问（TDMA）：将时间划分为多个时间片，每个节点在自己的时间片内传输数据
		- 例：![[Pasted image 20251113180351.png]]
	- 频分多路访问（FDMA）：将频率划分为多个频段，每个节点在自己的频段内传输数据
		- 例：![[Pasted image 20251113180410.png]]
	- 特点：公平，但低负载时效率低
## 随机接入协议
- 原理：节点在需要传输数据时，以信道最大速率发送数据，允许冲突但通过算法进行恢复
- 类型：
	- 时隙ALOHA：
		- 工作方式：
			- 每个帧固定长度，时间划分为多个等长时隙
			- 节点在时隙开始时发送数据，若冲突则等待随机时间后重传
			- 若时隙内有冲突，所有节点均检测到冲突，并以概率$p$在之后的时隙内重传
		- 特点：
			- 单节点可以以信道最大速率发送数据，且高度去中心化，实现简单
			- 冲突概率高，效率较低
		- 效率分析：也即成功时隙的占比
			- 假设有$N$个节点，每个节点以概率$p$发送数据
			- 单个节点成功的概率服从二项分布：$P(\text{success}) = p(1-p)^{N-1}$
			- 总效率为：$S = Np(1-p)^{N-1}$
			- 当$N \to \infty$时，取$p = \frac{1}{N}$，效率极限为：$\lim_{N \to \infty} S = \frac{1}{e} \approx 0.37$
	- 纯ALOHA：
		- 工作方式：
			- 节点在任意时间发送数据，若冲突则等待随机时间后重传
			- 节点无法检测冲突，只能通过超时机制进行恢复
		- 特点：
			- 实现简单，但冲突概率更高，效率更低
		- 效率分析：
			- 单个节点成功的概率为：$P(\text{节点传输}) \cdot P(\text{无冲突}) = p \cdot (1-p)^{2(N-1)}$
			- 当$N \to \infty$时，取$p = \frac{1}{2N}$，总效率极限为：$\lim_{N \to \infty} S = \frac{1}{2e} \approx 0.18$
	- 载波监听多路访问（CSMA）：
		- 工作方式：节点在发送数据前监听信道，若信道空闲则发送，若忙则等待
		- 特点：可能因同时监听到空闲信道而发生冲突，需要等待一个帧恢复
	- 带冲突检测的载波监听多路访问（CSMA/CD）：
		- 工作方式：节点在发送数据时监听信道，若检测到冲突则立即停止发送，并等待随机时间后重传
		- 特点：提高了冲突恢复效率，适用于有线网络，如以太网
## 轮询类协议
- 兼顾信道划分和随机接入的优点
- 类型：
	- 轮询协议（Polling）：
		- 工作方式：一个节点作为主节点，按顺序询问其他节点是否有数据发送
		- 优点：适用于从节点功能简单的早期网络
		- 问题：主节点单点故障，高轮询延迟
	- 令牌传递协议（Token Passing）：
		- 工作方式：一个特殊的帧（令牌）在节点间传递，持有令牌的节点可以发送数据
		- 优点：去中心化，避免单点故障，适用于高负载网络
		- 问题：令牌丢失或损坏需要恢复机制，且令牌也需要开销
## 总结

| 类别   | 核心机制           | 代表协议                       | 适用场景                    |
| ---- | -------------- | -------------------------- | ----------------------- |
| 信道划分 | 按时间、频率或码划分信道   | TDMA、FDMA                  | 高负载、对公平性要求高的场景          |
| 随机访问 | 动态竞争信道，允许冲突并恢复 | ALOHA、时隙ALOHA、CSMA、CSMA/CD | 低负载场景，以太网（CSMA/CD）、WiFi |
| 轮询类  | 节点轮流使用信道       | 轮询、令牌传递                    | 需平衡效率与公平的场景，如蓝牙、令牌环网    |

# 链路层编址
- *IP地址：网络层地址，用于[[S4 网络层#网际协议（IP）|网际协议]]中标识网络节点
- MAC地址：链路层地址，用于标识网络接口，也称LAN地址、物理地址或以太网地址
	- 结构：48位二进制数，通常表示为6组16进制数（如`00:1A:2B:3C:4D:5E`）
	- 分配：由IEEE负责分配，前24位为组织唯一标识符（OUI），后24位为设备标识符，由厂商烧录到网卡中
	- 特点：可移植（网卡更换后地址不变）
	- 功能：在局域网中唯一标识网络接口，实现节点间的通信
- 地址解析协议（ARP）：
	- 功能：将IP地址映射为MAC地址，实现网络层与链路层的互操作
	- ARP表：每个LAN上的IP节点都维护一个ARP表，存储IP地址与MAC地址的映射关系以及过期时间
	- 工作原理：
		- 同一LAN内通信：A向B发送数据报
			 1. A检查ARP表，若没有B的MAC地址，以目的MAC地址`FF:FF:FF:FF:FF:FF`广播ARP请求
			 2. 局域网内所有节点接收请求，只有B响应，发送ARP回复给A
			 3. A更新ARP表存储B的MAC地址直到超时，并发送数据报
		- 不同LAN间通信：A向B发送数据报
			 1. A创建目的为B的IP数据报，通过ARP获取网关路由器的MAC地址
			 2. A将数据报封装在链路层帧中，发送给网关路由器
			 3. 路由器收到帧后，提取IP数据报，通过ARP获取B的MAC地址，封装在新的链路层帧中发送给B
	- ARP攻击：
		- 原理：
			- 伪造IP地址和MAC地址实现欺骗，在网络中产生大量ARP通信使网络阻塞
			- 同时，攻击者可以窃听到网络中的数据包，进而欺骗数据传输的目的从而截获数据包
		- 原因：ARP协议采用信任模式，也即无条件接受ARP回复
# 以太网
- 主流的有线局域网技术，简单廉价，且性能优良，自70年代被发明起广泛应用
- 以太网帧结构：
	- 结构：![[Pasted image 20251113212451.png]]
	- 字段说明：
		- 前导码（Preamble）：7字节"10101010"模式 + 1字节"10101011"，用于同步双方时钟
		- 目的MAC地址和源MAC地址：各6字节，标识发送方和接收方的网络接口
		- 类型/长度字段：指示上层协议类型或数据字段长度
		- 数据字段：承载上层协议的数据，最小46字节，最大1500字节
		- 帧校验序列（CRC）：用于检测帧传输中的错误
- 以太网技术：
	- 拓扑结构：
		- 总线型拓扑：早期以太网采用同轴电缆作为共享介质，节点通过T型连接器连接到总线上
		- 星型拓扑：现代以太网采用交换机（Switch）作为中心节点，节点通过双绞线连接到交换机
	- 特点：
		- 无连接：收发网卡间没用握手过程
		- 不可靠：接收方没有任何ACK等，传递的数据流可能存在间隙
		- MAC协议：采用**CSMA/CD协议**进行链路访问控制
	- 算法流程：
		1. 网卡接受上层数据报，创建链路层帧
		2. 若检测到信道空闲，开始发送帧；否则等待信道空闲
		3. 若发送过程中未检测到任何其他传输，发送完成
		4. 若检测到冲突，立即停止发送，发送**拥塞信号**（Jam Signal）
			- 拥塞信号是一个48比特的数据，确保所有节点检测到冲突
		5. 终止后，进入**指数退避**状态
			- 在第$i$次冲突后，节点从$0$到$2^i-1$中随机选择一个整数$k$，等待$k$个时隙后重传
			- 目的是根据当前负载动态调整重传时间，减少冲突概率
	- 效率：$$\text{Efficiency} = \frac{1}{1 + 5\frac{t_{\text{prop}}}{t_{\text{trans}}}}$$
		- $t_{\text{prop}}$：信号在最大传播距离上传播所需时间，也即最大传播延迟
		- $t_{\text{trans}}$：帧传输时间，发送最大尺寸帧的时间
	- *802.3以太网标准：定义以太网的传输速率、物理介质等
	- *曼彻斯特编码：应用于以太网的物理层编码方式，通过电平变化表示比特值*
# 链路层交换机
- *集线器（Hubs）：早期网络设备，原封不动转发比特流，没有缓存和处理碰撞能力，仅属于物理层设备*
- 链路层交换机（Switches）：具备处理能力的链路层设备
	- 核心特性：
		- 存储-转发：接受完整帧后，进行检查帧，再转发，避免错误
		- 选择性转发：根据目的MAC地址选择输出端口，减少冲突域
		- 透明性：主机无需感知交换机的存在
		- 多碰撞域隔离：每个端口为独立碰撞域，减小冲突，提高性能


# 点对点协议(PPP)




# 链路虚拟化技术




