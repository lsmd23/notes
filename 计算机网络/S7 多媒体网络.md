- 多媒体应用已经成为目前网络应用的重要部分
	- 在网络中，多媒体应用可以传输视频、音频、图像等多种形式的数据
- **QoS**（Quality of Service，**服务质量**）是指网络为多媒体应用提供其正常运行所需的性能水平
	- 核心指标包括延迟、延迟抖动、丢包率等
	- 多媒体应用，尤其最近产生的虚拟现实设备等，对QoS的要求越来越高，成为这类技术发展的瓶颈之一
# 多媒体网络应用
- 多媒体应用的特征：
	- 延迟敏感：多媒体传输对延迟要求高，同时延迟抖动（jitter）也需要控制在一定范围内
		- 延迟抖动：指数据包到达时间的变化，过大的抖动会导致播放不流畅
	- 丢包容忍：多媒体应用通常可以容忍一定比例的数据包丢失
		- 视频流中丢失少量帧不会显著影响观看体验
		- 相比文件传输，多媒体应用可以接受一定的丢包率
- 多媒体网络服务：
	- 由于传输层的协议（UDP/TCP）提供的是“尽力而为”的服务，无法满足多媒体应用对QoS的要求
	- 多媒体应用通过在应用层上进行约束（如客户端缓冲、丢包恢复等）来提升服务质量，确保QoS要求
	- 音视频压缩技术：可以有效减少传输数据量，降低带宽需求
		- 音频压缩：
			- 模拟信号按固定速率采样（电话按8kHz，音乐按44.1kHz）
			- 量化对应的信号（将采样值近似为有限个离散值）
			- 编码（用二进制表示量化后的值）
			- 传输
			- 接受解码
		- 视频压缩：
			- 视频是按固定速率显示的图像序列，图像则是像素的二维阵列，每个像素都可以由比特表示
			- 视频压缩基于空间冗余和时间冗余进行压缩
## 流式存储应用
- 工作模式：
	- 音视频等资源存储在源服务器上
	- 当客户端请求播放时，服务器将数据按需传输给客户端
	- **流式传输**：客户端并不是在接收完整文件后再播放，而是播放已接收的数据，同时继续接收后续数据
- 交互与约束：
	- 支持VCR式的交互功能，如暂停、快进、快退等，可以接受数秒的延迟
	- 需要保证数据按时序播放，否则将会出现卡顿、丢帧等现象
- 典型场景：在线视频平台（如YouTube、Netflix等），音乐流媒体服务（如Spotify等）
## 实时会话式应用
- 工作模式：
	- 双向实时传输：两个媒体端之间进行实时的音视频通信
	- 传输过程：实时采集-传输-解码，需要保证时延
- 交互与约束：
	- 强交互性：用户期望实时响应，延迟过大会影响交流体验
	- 需要较低的延迟（可以容忍大约400ms的延迟）
	- 会话初始化：需要建立连接，在传输层层面需要了解IP地址，端口号、编码算法等信息
- 典型场景：视频会议（如Zoom、Microsoft Teams等），语音通话（如Skype、WhatsApp等）
## 流式实况应用
- 工作模式：
	- 实时生成：通过其他媒体端实时生成数据
	- 延迟播放：存在播放缓冲，播放端从缓冲区播放数据
- 交互与约束：
	- 低延迟要求：可以容许数十秒的延迟，但不宜过大
	- 需要处理网络波动，保证连续播放
- 典型场景：直播平台（如Twitch、YouTube Live等），在线广播（如网络电台等）
# 流式存储音视频
- 流式存储应用层优化：
	- 核心技术：保证在尽力而为服务下的QoS稳定
		- 客户端缓冲：抵消网络延迟和抖动的影响
		- UDP/TCP传输选择：根据应用需求选择合适的传输协议
		- 多编码速率适配：匹配客户端的带宽差异
	- 播放器功能：
		- 抖动消除：通过缓冲区平滑播放
		- 解压缩：还原比特流为音视频信号
		- 错误隐藏与恢复：处理丢包和错误
		- 交互功能：支持暂停、快进等操作
- 传输架构：
	- 基础架构：服务器直接传输
		- 示意图：![[Pasted image 20251126163530.png]]
		- 流程：
			- 文件直接以HTTP对象方式存储在服务器上
			- 客户端下载到浏览器，通过浏览器内置播放器播放
		- 问题：没有流式传输，初始延迟高，交互性差
	- 流式传输架构：采用流式传输协议
		- 示意图：![[Pasted image 20251126163710.png]]
		- 流程：
			- 客户端发送请求，获取包含视频元数据的元文件（metafile）
			- 浏览器启动播放器，并传递元文件
			- 播放器和服务器建立连接，通过HTTP协议接受流式传输数据
		- 优势：支持流式传输，降低初始延迟，提高交互性
	- 流式服务器架构：使用专门的流式服务器
		- 示意图：![[Pasted image 20251126163953.png]]
		- 流程：
			- 客户端向Web服务器发送请求展示描述文件
			- 文件传递给媒体播放器
			- 播放器与专门的流式服务器建立连接，通过非HTTP协议接受流式传输数据
		- 优势：专门优化流式传输，提升性能和QoS
- 客户端缓冲机制：
	- 原理：服务器以恒定速率发送数据，可能有波动。通过缓冲区存储，从缓冲区中以恒定速率播放，抵消网络波动影响
	- 示意图：![[Pasted image 20251126164327.png]]![[Pasted image 20251126164350.png]]
	- 需要一个初始延迟（缓冲时间）来填充缓冲区，确保播放连续性
- UDP/TCP传输选择：
	- UDP传输：
		- 按客户端要求速率发送（发送速率=解码速率）
		- 低延迟，抖动小（仅需抵消基础抖动）
		- 错误恢复：需单独实现（不可靠传输）
	- TCP传输：
		- 按TCP的最大速率进行发送
		- 按拥塞控制算法调整发送速率
		- 高延迟，抖动大（需较大缓冲区抵消抖动）
		- 可以穿过多数的防火墙，兼容性好
# 尽力而为服务优化——实时交互
- 实时交互应用：参考[[S7 多媒体网络#实时会话式应用|实时会话式应用]]
	- 以互联网电话应用为例，在生成时速率接近64kbps，传输过程中有各类丢包问题，要求接受延迟在150ms-400ms左右
- 播放延迟控制：
	- 固定播放延迟技术：
		- 流程：
			- 接收端尝试在数据块生成后的固定时间内（例如$q$毫秒）播放数据块
			- 若数据块在$q$毫秒内未到达，判定为迟到丢包，直接播放下一个数据块
			- 示意图：![[Pasted image 20251126165451.png]]
		- 问题：大的$q$值会增加延迟，小的$q$值会增加丢包率
	- 自适应播放延迟技术：试图选定一个最佳的$q$值
		- 算法：
			- $t_i$表示第$i$个数据块的的时间戳，也即在发送方生成的时间
			- $r_i$表示第$i$个数据块在接收方到达的时间
			- $p_i$表示第$i$个数据块的播放时间
			- 令$d_i$表示第$i$个数据块的平均网络时延的估计值，该估计值由下式得出：$$d_i=(1-u)d_{i-1}+u(r_i-t_i)$$其中$0<u<1$是一个常数，为平滑因子
			- 令$v_i$表示与估计平均时延的平均时延绝对偏差的估计值，该估计值由下式得出：$$v_i=(1-u)v_{i-1}+u| (r_i-t_i)-d_i |$$
			- 在每一个会话段开始时，播放时间设定为：$p_i=t_i+d_i+Kv_i$，其中$K$是一个常数，通常取值为4
			- 由此，设定了$Kv_i$足够大的时间，确保丢包率较低，同时又不会引入过大的延迟
			- 话段首包的判断：通过时间戳判断：当没有丢包时，认为20ms的间隔就是话段首包，有丢包时，则在20ms间隔基础上，还需满足序列号无间隙
		- 特点：
			- 动态调整播放延迟，适应网络变化
			- 平衡延迟和丢包率，提高用户体验
- 丢包恢复技术：
	- 前向纠错（FEC）：通过冗余信息重建丢失数据的近似
		- 简单FEC：
			- 原理：
				- 对每组$n$个数据块，通过异或操作，生成一个冗余数据块
				- 发送$n+1$个数据块，额外带宽开销为$\frac{1}{n}$
				- 接收端若丢失一个数据块，可以通过剩余的$n$个数据块和冗余块恢复
			- 权衡：
				- 需要同时接受$n+1$个数据块，增加延迟
				- $n$较大时，冗余开销较小，但恢复能力下降，同时恢复失败的概率增加
		- 低质量流FEC：
			- 原理：
				- 主流中传输高质量数据块
				- 冗余流中传输低质量数据块（编码率较低）
				- 丢包时，使用低质量数据块进行替换
				- 示意图：![[Pasted image 20251126171748.png]]
			- 特点：适用于带宽敏感但可容忍丢包的应用
	- 交织（Interleaving）：通过重新排列数据块顺序，减少连续丢包的影响
		- 原理：
			- 拆分数据：将数据块拆分为多个子块
			- 重组数据：按特定顺序，使得每个数据包包含来自不同子块的数据
			- 丢包恢复：若某数据包丢失，只会丢失每个子块的一部分，并不会造成整个数据块的丢失
			- 示意图：![[Pasted image 20251126172013.png]]
		- 特点：无额外开销，但需等待更多数据包到达拆分重组，对连续丢包的抵抗力弱
- 内容分发网络（CDN）：优化大文件传输，通过降低路径长度缓解丢包
	- 问题：长路径传输中，丢包率较高，影响多媒体应用的QoS，因此，将内容缓存到边缘服务器中，可以有效降低丢包率
		- 示意图：![[Pasted image 20251126172321.png]]
	- 工作流程：
		- 请求重定向：用户请求被DNS系统重定向到最近的边缘服务器
		- 内容缓存：边缘服务器缓存常用内容，减少跨网络传输
		- 文件传输：边缘服务器向用户提供内容，提升传输速度和稳定性
		- 示意图：![[Pasted image 20251126172411.png]]
		- 智能路由：CDN会知晓各个边缘CDN节点的情况以及请求节点ISP的距离，从而结合网络状况，选择最佳的边缘节点提供服务
# 实时会话应用协议
- 实时传输协议（Real-time Transport Protocol，RTP）：
	- 用于实时音视频传输的协议，定义音视频数据包结构
		- 载荷类型标识：标记音视频编码格式
		- 序列号：用于检测丢包和排序
		- 时间戳：用于同步和播放时间控制
	- 层级：封装在UDP段中，属于传输层上层协议（位于传输层和应用层之间）
	- 实例：以64kbps的PCM语音传输为例
		- 封装：每20ms收集160字节的编码语音数据，添加RTP头部，形成RTP数据包后通过UDP发送
		- 动态适配：RTP头部标记载荷类型，接收端根据标记选择解码器，可以动态适配不同编码格式
	- 注：RTP本身不提供QoS保障，需结合其他协议使用
- 其他协议类型：
	- RTCP（Real-time Transport Control Protocol）：
		- RTP的控制协议，提供传输质量反馈和统计信息
		- 帮助发送端调整传输参数，优化QoS
	- SIP（Session Initiation Protocol）：
		- 用于建立、修改和终止多媒体会话的信令协议
		- 管理会话参数，如参与者地址、媒体类型等
# 多服务类别与QoS保障
- 多服务类别：
	- 区分不同类型的网络服务，满足多样化的QoS需求
	- 例：
		- 考虑下述的一种传输链路：![[Pasted image 20251126184504.png]]
		- 当源主机在运行IP电话应用时，使用FTP进行传输，突发流量可能导致拥塞，从而引发丢包
		- 可以通过标记数据包，区分不同服务类别，优先处理IP电话数据包保证其QoS
- QoS保障原则：
	- **数据包标记与差异化处理**：标识不同类别数据包，并按策略进行差异化转发
	- **流量隔离**：某些流量异常理应不影响其他的流量（如音频流量超标），需要通过流量管制（policing）进行隔离
	- **资源利用**：保证有限资源在不同服务类别间的合理分配，提升整体网络性能
	- **呼叫准入**：一条链路应控制某个超出其能力的流量进入，避免过载
- 调度管制机制：
	- 调度：决定数据包的发送顺序
		- 策略：
			- FIFO（First In First Out）：简单的先来先服务，丢弃时按照尾部丢弃，随机丢弃等简单方式处理
				- 示意图：![[Pasted image 20251126185217.png]]
			- 优先级调度（Priority Scheduling）：根据数据包的优先级进行调度，高优先级数据包优先发送
				- 示意图：![[Pasted image 20251126185233.png]]
			- 轮询调度（Round Robin Scheduling）：按类别轮流发送数据包，确保各类别公平访问带宽
				- 示意图：![[Pasted image 20251126185251.png]]
			- 加权公平队列（Weighted Fair Queuing，WFQ）：根据类别权重分配带宽，权重高的类别获得更多带宽，基于轮询调度扩展
				- 示意图：![[Pasted image 20251126185310.png]]
	- 管制（Policing）：控制流量进入网络的速率，防止过载
		- 目标：限制流量不超过预定的参数以保护网络资源
		- 令牌桶（Token Bucket）机制：
			- 原理：
				- 以恒定速率$r$生成令牌，存储在最大为$b$的桶中
				- 每个数据包发送需消耗相应数量的令牌
				- 若桶中令牌不足，数据包被丢弃或延迟发送
			- 示意图：![[Pasted image 20251126185516.png]]
	- 结合调度与管制（如上述的令牌桶机制与WFQ结合使用），可以实现对多服务类别的QoS保障
		- 示意图：![[Pasted image 20251126185611.png]]
- IETF架构：IETF提出了一种多服务类别的QoS保障架构
	- 区分服务：在网络边缘路由器进行流量标记和管制，核心路由器基于标记进行调度
		- 边缘路由器：进行逐流管理，标记数据包为"in-profile"或"out-profile"
		- 核心路由器：进行逐类管理，基于类别进行调度，优先转发"in-profile"数据包
	- 集成服务：提供端到端的QoS保障，维护每个流的状态信息
		- 保证服务：对经由令牌桶的流量，延迟上界是可计算的
			- 示意图：![[Pasted image 20251126185951.png]]
		- 受控负载服务：为动态变化的流量提供近似于无拥塞网络的服务质量
- 无线Mesh网络：一种新型的多媒体网络架构
	- 特点：
		- 多跳自组织：自愈合、自组织、拓扑结构灵活
		- 高带宽：最大可达150Mbps
		- 多用途：支持多种应用，如视频监控、环境监测等
		- 低成本：节点可使用廉价设备，部署灵活
	- H.264编码：
		- 将视频拆分成帧，在重组成帧组的压缩方式
		- I帧：关键帧，独立编码，最为重要
		- P帧：预测帧，基于前一帧编码，丢失影响后续帧
		- B帧：双向预测帧，基于前后帧编码，最不重要
	- 在Mesh网络的链路层中，根据H.264编码的帧类型，设计不同优先级的调度机制
		- 高优先级队列：存储I帧，确保关键数据传输
		- 中优先级队列：存储P帧，保证预测数据传输
		- 低优先级队列：存储B帧，非关键数据传输
		- 示意图：![[Pasted image 20251126190326.png]]
---
[[S8 网络中的安全]]