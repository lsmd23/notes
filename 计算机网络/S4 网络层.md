- 网络层：负责在主机之间传输数据包，提供逻辑寻址和路由选择功能
	- 在发送端：将报文封装成数据包，添加源IP地址和目标IP地址
	- 在接收端：根据目标IP地址将数据包解封装，提取出报文
	- 关键功能：
		- 转发：根据目标IP地址选择合适的路径将数据包发送到目的地
		- 路由：确定数据包传输路径的过程
- 网络层协议：位于主机和路由器之间的协议
	- *传输层协议则是处理进程之间通信的协议*
	- 网络服务模型：发送端和接收端的特性
		- 内容：确保交付、时延上界、有序分组、安全性、最小带宽等
# 虚拟电路与数据报网络
- 虚拟电路网络（Virtual Circuit Network, VCN）：网络层的连接导向服务
	- 特点：
		- 源和目的的路径和电话电路很相似
		- 在传输时，为每次连接进行建立和拆除
		- 每组连接都有一个唯一的虚拟电路标识符（VCI），路径上的每个路由器都维护一个VCI表，表示连接的状态
	- 组成：
		- 源到目的的路径
		- VC编号：每个连接的唯一标识符
		- 转发表：路由器维护的VCI映射表，负责将输入VCI映射到输出VCI和输出端口（也即记录连接的源和目的）![[Pasted image 20251029163612.png]]
	- 协议：信令协议（用于建立和拆除连接），目前已很少使用
- 数据报网络（Datagram Network）：网络层的无连接服务
	- 特点：
		- 每个数据包独立传输，包含完整的源和目的地址
		- 路由器根据目标地址决定数据包的转发路径
		- 不需要建立连接，适合动态变化的网络环境
	- 转发表：由两列组成，分别是目的地址范围和链路接口
		- 地址范围：用二进制表示的IP地址
		- 链路接口：数据包发送的输出端口
		- **最长前缀匹配**：由于地址的长度很长，难以全部存储，因此实际的转发表通常只存储地址的前缀部分。路由器在查找转发表时，选择与目标地址匹配的最长前缀项进行转发，解决查找时间的问题
- 对比：
	- 现在的互联网主要采用数据报网络
		- 计算机之间的数据交换是一种弹性服务、无需严格要求
		- 由于互联网链路的复杂性，难以组织起统一的虚拟服务
	- 虚拟电路网络适用于需要可靠连接的场景，如电话网络
# 路由器工作原理
- 路由器（router)：运行路由算法/协议，将数据报从一个网络转发到另一个网络的设备
- 路由器的组成：如图所示![[Pasted image 20251102190433.png]]
	- 输入端口：![[Pasted image 20251102191235.png]]
		- 线路终端（line termination)：处理物理层数据，负责接收和发送比特流
		- 数据链路层处理：处理链路层帧，参考[[|链路层]]
		- 查找、转发、排队等功能：根据目标地址查找转发表，决定数据包的输出端口等网络层功能
			- 转发机制：**分散式交换**
				- 对每个数据包按照转发表逐个查找，决定输出端口
				- 排队机制：当输出端口繁忙时，数据包进入排队等待发送
			- **输入端口排队**：当交换机忙时，数据包进入输入端口队列等待处理
				- 头对头阻塞：输入数据包阻塞会导致输出端口空闲，从而发生阻塞，导致延迟
	- 交换机：路由器的核心，在输入端口和输出端口之间传输数据包
		- 交换结构：
			1. 经内存交换：数据包先存储在内存中，再从内存发送到输出端口
				- 特点：**存储-转发**模式，速率受内存速度限制，且存在延迟
			2. 经总线交换：通过共享总线连接输入端口和输出端口
				- 特点：成本低，但总线带宽有限，可能成为瓶颈
			3. 经互联网络交换：使用专用的交换网络连接输入端口和输出端口
				- 特点：高性能，解决瓶颈问题适合大规模路由器，但成本较高
	- 输出端口：如图所示![[Pasted image 20251102191816.png]]
		- 排队：当多个数据包竞争同一输出端口时，进行排队
		- 数据链路层处理：将数据包封装成**链路层帧**，准备发送
		- 线路终端：将数据包转换为**物理层信号**，发送到链路上
		- 关键机制：排队与缓冲
			- **输出端口排队**：当输出端口忙时，数据包进入输出端口队列等待发送
			- 缓冲容量规划：根据流量特性和服务质量要求，设计合适的缓冲区大小，避免丢包和延迟过大
# 网际协议（IP）
## 数据报格式
- 格式示意图：![[Pasted image 20251102192454.png]]
	- **版本**（Version, 4 bits)：表示IP协议的版本号，IPv4为4，IPv6为6
	- **首部长度**（Header Length, 4 bits)：表示IP首部的长度，以32位字为单位
	- **服务类型**（Type of Service, 8 bits)：用于指示数据报的优先级和服务质量要求
	- **总长度**（Total Length, 16 bits)：表示整个IP数据报的长度，包括首部和数据部分，以字节为单位
	- **标识**（Identification, 16 bits)：用于唯一标识数据报，主要用于分片和重组
	- **标志**（Flags, 3 bits)：用于控制和标识数据报的分片
	- **片偏移**（Fragment Offset, 13 bits)：表示数据报分片在原始数据报中的位置
	- **寿命字段**（Time to Live, 8 bits)：用于限制数据报在网络中的生存时间，防止数据报在网络中无限循环
	- **协议**（Protocol, 8 bits)：指示数据报携带的上层协议类型，如TCP、UDP等
	- **头部校验和**（Header Checksum, 16 bits)：用于检测IP首部在传输过程中是否出错
	- **源和目的IP地址**（Source and Destination IP Address, 32 bits each)：分别表示数据报的发送方和接收方的IP地址
	- **选项**（Options, variable length)：用于提供额外的控制信息，可选字段
	- **填充**（Padding, variable length)：用于确保IP首部长度为32位的整数倍
- IP分片与重组（IP Fragmentation and Reassembly）
	- **最大传输单元**（MTU）：链路层帧所能承载的最大数据长度，不同的链路层的MTU不同
	- 分片：当数据报长度超过MTU时，路由器将数据报分成多个片段进行传输
		- 每个片段都有自己的IP首部，且标识、标志和片偏移字段用于重组
	- 重组：在最终目的地主机上，根据标识、标志和片偏移字段将分片重新组装成完整的数据报
	- 示例：![[Pasted image 20251102193302.png]]
## IPv4编址
- IP地址：32位的标识，标识主机或路由器的接口，分为子网部分和主机部分
	- **子网**（Subnet)：**不经过路由器**就可以直接互联的一组主机，是网络中的一个分组
		- 子网掩码：标识IP地址中哪一部分是子网部分，哪一部分是主机部分，以"/xxx"的形式表示（如：223.1.1.0/24表示32位中的前24位为子网部分）
			- 被标识的位也被称为网络**前缀**
		- 不同的子网之间通过路由相连接，每个子网通常还留有一些地址供路由器接口使用
	- **无类别域间路由**（Classless Inter-Domain Routing, CIDR)：一种灵活的IP地址分配方法
		- 通过子网掩码，灵活划分子网大小，避免地址浪费
		- 允许路由器使用前缀进行路由选择，提高路由效率	
- IP地址的配置：
	- 静态配置：手动设置IP地址，适用于服务器等固定设备
	- 动态配置：通过DHCP等协议自动分配IP地址，适用于客户端设备
		- **动态主机配置协议**（Dynamic Host Configuration Protocol, DHCP)：一种自动分配IP地址的协议，允许动态的配置一台主机的IP地址及其他网络参数
			- 工作流程：
				1. 主机使用源地址0.0.0.0和目的地址255.255.255.255在链路层广播DHCP发现报文，寻找可用的DHCP服务器
				2. DHCP服务器响应，提供IP地址和其他配置信息
				3. 主机请求分配的IP地址
				4. DHCP服务器确认分配IP地址
				- 示例：![[Pasted image 20251102194815.png]]![[Pasted image 20251102194820.png]]
- IP地址的获取：设备获取IP地址依靠其服务提供商的地址分配
	- 层次化寻址：提供商的IP地址块再分配给下级提供商或最终用户，按照层次化的方式进行地址的组织
	- ICANN：（Internet Corporation for Assigned Names and Numbers)负责全球IP地址分配和管理的组织
- 网络地址转换（Network Address Translation, NAT)：一种将私有IP地址转换为公共IP地址的技术
	- 私有IP地址：在局域网内使用的IP地址，不在互联网上路由
	- 公共IP地址：在互联网上唯一标识设备的IP地址
	- 工作原理：NAT设备在数据包进出局域网时，修改源或目的IP地址，实现私有地址与公共地址之间的转换
	- 优点：
		- 节省公共IP地址资源
		- 提高网络安全性，隐藏内部网络结构

# 路由算法


