- 在汇编语言中，代码的控制结构和高级语言有很大不同。汇编语言中使用`goto`指令来实现跳转和分支控制
# 条件码
- 条件码寄存器：单比特的寄存器，用于存储一些条件状态信息
	- 进位标志（CF）：表示上一次运算是否产生了**进位或借位**
	- 零标志（ZF）：表示上一次运算的结果是否**为零**
	- 符号标志（SF）：表示上一次运算的结果是**正数还是负数**
	- 溢出标志（OF）：表示上一次有符号运算**是否产生了溢出**
- 条件码的设置：
	- 显式设置：通过特定指令直接设置条件码
		- ==`cmp`指令==：`cmp a b`
			- 计算`b - a`，但不存储结果，根据这个结果设置条件码
		- ==`test`指令==：`test a b`
			- 计算`a & b`，但不存储结果，根据这个结果设置条件码
			- `test %rX %rX`：用于检查寄存器`%rX`是否为零
			- `test %rX %rY`：用于检查寄存器`%rX`和`%rY`是否有共同的位被设置
	- 隐式设置：各类算术运算都会根据结果自动设置条件码
- 条件码的访问：
	- 显式访问：[[L4 机器指令-控制#^465c5f|setX指令]]
	- 隐式访问：[[L4 机器指令-控制#^35d575|跳转指令(jX)]]、[[L4 机器指令-控制#^8f9c18|条件mov指令]]
# 条件分支的实现
- ==跳转指令(jX)==：根据条件码跳转到不同的代码块 ^35d575
	- `jmp label`：无条件跳转到`label`
	- `je label`：如果零标志（ZF）被设置为1，跳转到`label`
	- `jne label`：如果零标志（ZF）未被设置为1，跳转到`label`
	- `js label`：如果符号标志（SF）被设置为1，跳转到`label`
	- `jns label`：如果符号标志（SF）未被设置为1，跳转到`label`
	- `jg label`：如果ZF=0且SF=OF，跳转到`label`（也即有符号数的大于）
	- `jge label`：如果SF=OF，跳转到`label`（也即有符号数的大于等于）
	- `jl label`：如果SF≠OF，跳转到`label`（也即有符号数的小于）
	- `jle label`：如果ZF=1或SF≠OF，跳转到`label`（也即有符号数的小于等于）
	- `ja label`：如果CF=0且ZF=0，跳转到`label`（也即无符号数的大于）
	- `jb label`：如果CF=0，跳转到`label`（也即无符号数的大于等于）
- ==`SetX`指令==：根据条件码的状态，将最低位设置位0或1 ^465c5f
	- `sete %al`：如果ZF=1，将`%al`设置为1，否则设置为0
	- `setne %al`：如果ZF=0，将`%al`设置为1，否则设置为0
	- `sets %al`：如果SF=1，将`%al`设置为1，否则设置为0
	- `setns %al`：如果SF=0，将`%al`设置为1，否则设置为0
	- `setg %al`：如果ZF=0且SF=OF，将`%al`设置为1，否则设置为0，用于有符号数的大于比较
	- `setge %al`：如果SF=OF，将`%al`设置为1，否则设置为0，用于有符号数的大于等于比较
	- `setl %al`：如果SF≠OF，将`%al`设置为1，否则设置为0，用于有符号数的小于比较
	- `setle %al`：如果ZF=1或SF≠OF，将`%al`设置为1，否则设置为0，用于有符号数的小于等于比较
	- `seta %al`：如果CF=0且ZF=0，将`%al`设置为1，否则设置为0，用于无符号数的大于比较
	- `setb %al`：如果CF=0，将`%al`设置为1，否则设置为0，用于无符号数的大于等于比较
	- 注：寄存器最低一位的标识如下图所示：![[Pasted image 20251020140807.png]]
	- 例：![[Pasted image 20251020140925.png]]
		- 注：`mov`指令对单位操作时，会将高位清零
- ==`cmov`指令==：根据条件码进行`mov`的指令 ^8f9c18
	- 在1995年后的x86架构中被支持
	- 基本格式为`cmov(xx) %rX %rY`：根据条件码的状态，将寄存器`%rX`的值移动到寄存器`%rY`
	- 在高级语言中，被用于条件表达式`val = test ? Then_expr : Else_expr`的实现
		- 问题：计算条件表达式会先计算两个分支的值，可能会带来额外的开销，甚至是意想不到的错误结果，如`val = x > 0 ? x *= 7 : x += 3`的情况
- 条件控制举例：
	- ![[Pasted image 20251020141020.png]]
	- 用高级语言表示为：![[Pasted image 20251020141042.png]]
# 循环控制
- 使用`goto`指令可以实现循环控制
	- 例：![[Pasted image 20251020142058.png]]表示为汇编语言：![[Pasted image 20251020142124.png]]
	- `do{} while()`循环的实现：![[Pasted image 20251020142226.png]]
	- `while() {}`循环的实现：
		1. 跳转到中间实现：![[Pasted image 20251020142256.png]]
			- 例：![[Pasted image 20251020142418.png]]
		2. 转化为`do{} while()`循环：![[Pasted image 20251020142510.png]]
			- 例：![[Pasted image 20251020142556.png]]
	- `for(;;)`循环的实现：转化为`do{} while()`循环
		- 例：![[Pasted image 20251020142710.png]]
---
[[L5 机器指令-过程]]
