- 程序的性能并非仅由[[L1 基础知识#算法的增长速度|渐进复杂度]]决定，还受常数因子的影响，因此在实际编程中需要关注程序的性能优化
# 编译器进行的优化
- [[L8 代码优化|编译器在代码生成时就会进行大量的优化]]，以提升生成代码的执行效率
- 常见优化技术：
	- [[L8 代码优化#^e9c8ad|代码移动]]
	- [[L8 代码优化#^f0220a|强度削减]]
	- [[L7 代码生成#^498c21|公共子表达式消除]]
	- 内联过程调用
	- ……
- 编译器的优化总是**偏向于保守**，以确保生成代码的正确性，因此程序员仍需关注代码的性能优化
# 编译器优化瓶颈
- 过程调用：
	- 例：大小写转换程序：
		```c
		void lower(char* s)
		{
			int i;
			for (i = 0; i < strlen(s); i++) {
				if (s[i] >= 'A' && s[i] <= 'Z')
					s[i] -= ('A' - 'a');
			}
		}
		```
		- 问题：`strlen(s)`在每次循环中都会被调用，且库函数中调用是$O(N^2)$复杂度的，导致不必要的重复计算
	- 优化：将过程调用移出循环
		```c
		void lower2(char* s)
		{
			int i;
			int len = strlen(s);
			for (i = 0; i < len; i++) {
				if (s[i] >= 'A' && s[i] <= 'Z')
					s[i] -= ('A' - 'a');
			}
		}
		```
	- 性能提升：由平方级复杂度提升为线性复杂度![[Pasted image 20251229101456.png]]
	- 编译器瓶颈：编译器总是将调用过程视为黑箱，参与一个过程有可能改变全局的一些状态，从而影响其他代码，因此无法确定将调用移出循环是否安全
- 内存别名：
	- 例：二维数组每行求和
		```c
		void sum_rows1(double *a, double *b, long n) {  
			long i, j;  
			for (i = 0; i < n; i++) {  
				b[i] = 0;  
				for (j = 0; j < n; j++)  
					b[i] += a[i*n + j];  
			}  
		}
		```
		- 问题：假设`b`指向`a`的第二行，则会得到如下的执行结果![[Pasted image 20251229101920.png]]
	- 优化：使用临时变量
		```c
		void sum_rows2(double *a, double *b, long n) {  
			long i, j;  
			for (i = 0; i < n; i++) {  
				double temp = 0;  
				for (j = 0; j < n; j++)  
					temp += a[i*n + j];  
				b[i] = temp;  
			}  
		}
		```
	- 编译器瓶颈：编译器无法确定指针`a`和`b`是否会指向同一块内存区域，从而影响代码的正确性，因此在没有足够信息的情况下，无法进行该优化
# 指令级并行(ILP)
- 现代CPU架构：
	- 示意图：![[Pasted image 20251229103316.png]]
	- 超标量处理器：能在一个周期内发射多条指令进行并行执行，从顺序指令流中动态调度指令实现指令级并行（Instruction Level Parallelism, ILP）
	- 例：Nehalem架构CPU
		- 可以并行执行1次加载（带地址计算）、1次存储（带地址计算）、2次简单整数运算、1次复杂整数运算、1次浮点乘法、1次浮点加法
		- 多于1个时钟周期的指令可以被流水线化，以提升吞吐量
- 循环优化提升ILP：以向量求和/乘积为例
	- 结构体和方法：![[Pasted image 20251229103918.png]]
	- 未优化代码：
		```c
		void combine1(vec_ptr v, data_t *dest)
		{
			long int i;
		    *dest = IDENT;
		    for (i = 0; i < vec_length(v); i++) 
		    {
			    data_t val;
			    get_vec_element(v, i, &val);
			    *dest = *dest OP val;
			}		        
		}
		```
		- 性能指标：用CPE衡量，也即每次运算所需的时钟周期数

