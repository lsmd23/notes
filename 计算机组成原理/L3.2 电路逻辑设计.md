# 基础电路设计
- 信号与表示：在电路中，用高电平（1）和低电平（0）来表示数字信号
	- 在实际电路中，高低电平间有一定的范围，称为噪声容限
- 门电路：[[L5 门电路|数字电子技术基础——门电路]]
- 组合逻辑电路：由门电路构成的无环的电路，其输出仅与当前输入有关（参见[[L6 组合逻辑电路|数字电子技术基础——组合逻辑电路]]）
	- 例1：比较器：
		- 位比较器：![[Pasted image 20251110112347.png]]
		- 字比较器：![[Pasted image 20251110112404.png]]
			- HCL描述：
				```VHDL
				bool Equal = (A == B);
				```
	- 例2：多路选择器：
		- 位二路选择器：![[Pasted image 20251110112421.png]]
		- 字二路选择器：![[Pasted image 20251110113306.png]]
			- HCL描述：
				```VHDL
				int Out = [
					s : A;
					1 : B;
				];
				```
	- 算术逻辑单元（ALU）：
		- 功能：对两个输入数执行多种算术和逻辑运算，并输出结果
		- 结构：由多个功能单元组成，通过选择器选择输出
		- 例：![[Pasted image 20251110113520.png]]
			- HCL描述：
			```VHDL
			int Out;
			switch (Op) {
				case 0000: Out = A & B; break; // AND
				case 0001: Out = A | B; break; // OR
				case 0010: Out = A + B; break; // ADD
				case 0110: Out = A - B; break; // SUB
				case 1100: Out = ~(A | B); break; // NOR
				// 其他操作
				default: Out = 0; break;
			}
			```
- 存储电路：具有存储功能的电路元件，通过带环的组合逻辑电路实现（参见[[L7 半导体存储电路|数字电子技术基础——半导体存储电路]]）
	- [[L7 半导体存储电路#位的存储和SR锁存器|锁存器]]：可以存储一个位的信息的电路单元
	- 触发器：加入时钟信号和数据信号，可以控制数据存储的模式
		- 按触发方式可以分为[[L7 半导体存储电路#电平触发的触发器|电平触发]]、[[L7 半导体存储电路#脉冲触发的触发器|脉冲触发]]和[[L7 半导体存储电路#边沿触发的触发器|边沿触发]]
		- 按翻转规则可以分为SR触发器、JK触发器、T触发器和D触发器（详见[[L7 半导体存储电路#触发器的分类及功能表示法|触发器的分类及功能表示法]]）
	- [[L7 半导体存储电路#寄存器 Register|寄存器]]：由多个触发器组成的存储单元，可以存储多位信息
		- 寄存器的流水线式工作，可以提高数据处理速度
			- 例：累加器![[Pasted image 20251117103434.png]]波形图![[Pasted image 20251117103446.png]]
	- 随机存取存储器（RAM）：可以存储大量数据的存储单元，由多个寄存器组成（参见[[L7 半导体存储电路#大规模半导体存储器|大规模存储器]]）
- 硬件描述语言（HDL）：用于描述数字电路结构和行为的编程语言
	- 常用HDL语言有VHDL和Verilog
	- 简要介绍：
		- 数据类型：布尔`bool`、整数`int`等
		- 表达式和语句：赋值、条件语句、循环语句等
		- 语法和C语言类似，但有特定的硬件描述结构
# CPU的设计和执行
- CPU的指令执行（SEQ）：分为六个阶段
	- 如图：![[Pasted image 20251117111502.png]]
		- IF（Instruction Fetch）：取指令
		- ID（Instruction Decode）：译码
		- EX（Execute）：执行
		- MEM（Memory Access）：访存
		- WB（Write Back）：写回
		- PC Update：更新程序计数器
    - 计算机中，指令的执行是通过循环这一过程实现的
- 指令的编码构成： ^d653bc
	- 直接变量：
		- 示意图：![[Pasted image 20251117112051.png]]
		- 指令字节：`icode`（4位）+ `ifun`（4位）
		- 寄存器编号：`rA`（4位）+ `rB`（4位）
		- 常数字：`valC`（64位）
	- 待计算变量：
		- 取指阶段：读取上述直接变量以及下一指令地址`valP`
		- 译码阶段：
			- `srcA`：寄存器A的ID
			- `srcB`：寄存器B的ID
			- `valA`：寄存器A的值
			- `valB`：寄存器B的值
			- `dstE`：目的寄存器E的ID
			- `dstM`：目的寄存器M的ID
		- 执行阶段：
			- `valE`：ALU的输出值
			- `Cnd`：分支/移动的标志位
		- 访存阶段：
			- `valM`：从内存中读取的数据
- 算数逻辑指令：
	- 指令格式：![[Pasted image 20251117112530.png]]
	- 执行过程：
		1. 取指令：从内存中取出2字节指令
		2. 译码：根据`rA`和`rB`读取寄存器的值
		3. 执行：根据`ifun`执行相应的算术逻辑操作，并设置条件码
		4. 访存：无（Y86-64中算术逻辑指令不允许访问内存）
		5. 写回：将结果写回寄存器
		6. 更新`PC`：令PC寄存器+2
	- 执行细节：![[Pasted image 20251117113125.png]]
- `rmmovq`指令：
	- 指令格式：![[Pasted image 20251117113220.png]]
	- 执行过程：
		1. 取指令：从内存中取出10字节指令
		2. 译码：根据`rA`和`rB`读取寄存器的值
		3. 执行：计算目标地址
		4. 访存：写入目标内存地址
		5. 写回：无
		6. 更新`PC`：令PC寄存器+10
	- 执行细节：![[Pasted image 20251117113303.png]]
- `popq`指令：
	- 指令格式：![[Pasted image 20251117113622.png]]
	- 执行过程：
		1. 取指令：从内存中取出2字节指令
		2. 译码：根据`rA`读取寄存器的值（也即栈指针`%rsp`）
		3. 执行：计算栈顶地址（`%rsp + 8`）
		4. 访存：从旧的栈顶地址读取数据
		5. 写回：将数据写回寄存器，并更新栈指针
		6. 更新`PC`：令PC寄存器+2
	- 执行细节：![[Pasted image 20251117113709.png]]
- `cmovXX`指令：
	- 指令格式：![[Pasted image 20251117114059.png]]
	- 执行过程：
		1. 取指令：从内存中取出2字节指令
		2. 译码：根据`rA`和`rB`读取寄存器的值
		3. 执行：检查条件码，决定是否将目的寄存器设置为空（也即`0xF`）
		4. 访存：无
		5. 写回：根据条件码将数据写回寄存器
		6. 更新`PC`：令PC寄存器+2
	- 执行细节：![[Pasted image 20251117114203.png]]
- `jXX`指令：
	- 指令格式：![[Pasted image 20251117114252.png]]
	- 执行过程：
		1. 取指令：从内存中取出9字节指令，并将PC指令寄存器+9存入`valP`
		2. 译码：无
		3. 执行：检查条件码，决定是否跳转分支
		4. 访存：无
		5. 写回：无
		6. 更新`PC`：根据条件码更新PC寄存器到目标地址或保持不变
	- 执行细节：![[Pasted image 20251117114416.png]]
- `call`指令：
	- 指令格式：![[Pasted image 20251117114540.png]]
	- 执行过程：
		1. 取指令：从内存中取出9字节指令，并将PC指令寄存器+9存入`valP`
		2. 译码：根据寄存器`%rsp`读取栈指针
		3. 执行：将栈指针`%rsp`减8
		4. 访存：将返回地址`valP`写入栈顶
		5. 写回：更新栈指针寄存器
		6. 更新`PC`：将PC寄存器设置为目标地址
	- 执行细节：![[Pasted image 20251117114648.png]]
- `ret`指令：
	- 指令格式：![[Pasted image 20251117114659.png]]
	- 执行过程：
		1. 取指令：从内存中取出1字节指令
		2. 译码：根据寄存器`%rsp`读取栈指针
		3. 执行：将栈指针`%rsp`减8
		4. 访存：从旧的栈顶地址读取返回地址
		5. 写回：更新栈指针寄存器
		6. 更新`PC`：将PC寄存器设置为返回地址
	- 执行细节：![[Pasted image 20251117115705.png]]
---
[[L3.3 SEQ处理器设计]]